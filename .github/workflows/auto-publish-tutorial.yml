name: Auto Publish AI Tutorial

on:
  schedule:
    - cron: "0 15 * * *"
  workflow_dispatch:

concurrency:
  group: auto-publish
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Discover topics
        run: npm run discover-topics

      - name: Generate tutorial
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-5-mini
          OPENAI_TIMEOUT_MS: "120000"
          OPENAI_MAX_RETRIES: "3"
          MIN_WORDS_EN: "900"
          MAX_WORDS_EN: "1500"
          MIN_WORDS_FR: "850"
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_IMAGE_MODEL: ${{ secrets.GEMINI_IMAGE_MODEL }}
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
          IMAGES_ENABLED: "1"
        run: npm run generate-tutorial

      - name: Compact queue
        run: node scripts/compact-queue.mjs

      - name: Detect post changes
        run: |
          CHANGED_POSTS="$(git status --porcelain | awk '{print $2}' | grep '^content/posts/' || true)"

          if [ -n "$CHANGED_POSTS" ]; then
            echo "POST_GENERATED=1" >> "$GITHUB_ENV"

            SLUGS="$(echo "$CHANGED_POSTS" | grep '^content/posts/' | grep -v '^content/posts/fr/' | sed 's|^content/posts/||' | sed 's|\\.md$||' | paste -sd ',' - || true)"
            if [ -z "$SLUGS" ]; then
              SLUGS="$(echo "$CHANGED_POSTS" | grep '^content/posts/fr/' | sed 's|^content/posts/fr/||' | sed 's|\\.md$||' | paste -sd ',' - || true)"
            fi

            echo "POST_SLUGS=$SLUGS" >> "$GITHUB_ENV"
            echo "Detected post slugs: $SLUGS"
          else
            echo "POST_GENERATED=0" >> "$GITHUB_ENV"
            echo "No post file changed under content/posts/."
          fi

      - name: Lint
        run: npm run lint

      - name: Build
        env:
          NEXT_PUBLIC_SITE_URL: https://aisignals.dev
        run: npm run build

      - name: Commit and push
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add content/posts data/topics-queue.json
          git commit -m "chore: auto-publish tutorial"
          git push

      - name: Validate deployment URLs (prod)
        if: ${{ env.POST_GENERATED == '1' }}
        run: |
          if [ -z "${POST_SLUGS:-}" ]; then
            echo "POST_SLUGS is empty even though a post was generated."
            exit 1
          fi

          BASE_URL="https://aisignals.dev"
          IFS=',' read -r -a slugs <<< "$POST_SLUGS"

          for slug in "${slugs[@]}"; do
            for path in "/posts/${slug}" "/fr/posts/${slug}"; do
              url="${BASE_URL}${path}"
              echo "Waiting for ${url}"
              ok=0

              for i in {1..42}; do
                code="$(curl -sSL -o /dev/null -w '%{http_code}' "${url}" || true)"
                if [ "${code}" = "200" ]; then
                  echo "OK: ${url}"
                  ok=1
                  break
                fi
                echo "[${i}/42] HTTP ${code}"
                sleep 10
              done

              if [ "${ok}" != "1" ]; then
                echo "Deployment validation failed for ${url}"
                exit 1
              fi
            done
          done

      - name: Fail if no tutorial was generated
        if: ${{ env.POST_GENERATED != '1' }}
        run: |
          echo "Automation ran but did not produce a new tutorial. Failing to trigger an alert."
          exit 1

